<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hábitos 30 Días</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --txt: #e0e0e0; --accent: #81c784; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); padding: 20px; margin: 0; }
        .habito { background: var(--card); display: flex; justify-content: space-between; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; }
        .completado { border: 1px solid var(--accent); opacity: 0.6; }
        .controles { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex-grow: 1; padding: 10px; border-radius: 5px; border: none; background: #2c2c2c; color: white; }
        button { padding: 10px; border-radius: 5px; border: none; background: var(--accent); color: #121212; font-weight: bold; }
        canvas { background: #1e1e1e; padding: 10px; border-radius: 10px; margin-top: 20px; }
        h3 { color: var(--accent); margin-top: 30px; }
    </style>
</head>
<body>

    <h2>Hábitos Hoy</h2>
    <div class="controles">
        <input type="text" id="nuevoHabito" placeholder="Nuevo hábito...">
        <button onclick="agregarHabito()">+</button>
    </div>
    
    <div id="listaHabitos"></div>

    <h3>Progreso (Últimos 30 días)</h3>
    <canvas id="graficoHabitos" width="400" height="200"></canvas>

    <script>
        let datos = JSON.parse(localStorage.getItem('app_habitos_v3')) || { habitos: [], historial: {} };

        // 1. Lógica de Reinicio Diario
        function verificarReinicio() {
            const hoy = new Date().toLocaleDateString();
            const ultimaFecha = localStorage.getItem('ultima_conexion');

            if (ultimaFecha && ultimaFecha !== hoy) {
                // Antes de reiniciar, guardamos cuánto logramos ayer para el gráfico
                const total = datos.habitos.length;
                const hechos = datos.habitos.filter(h => h.check).length;
                const porcentaje = total > 0 ? (hechos / total) * 100 : 0;
                
                datos.historial[ultimaFecha] = porcentaje;
                
                // Limpiar los hábitos para el nuevo día
                datos.habitos.forEach(h => h.check = false);
            }
            localStorage.setItem('ultima_conexion', hoy);
            render();
            actualizarGrafico();
        }

        function render() {
            const contenedor = document.getElementById('listaHabitos');
            contenedor.innerHTML = '';
            datos.habitos.forEach((h, i) => {
                contenedor.innerHTML += `
                    <div class="habito ${h.check ? 'completado' : ''}" onclick="toggle(${i})">
                        ${h.nombre} <span>${h.check ? '✅' : '⚪'}</span>
                    </div>`;
            });
            localStorage.setItem('app_habitos_v3', JSON.stringify(datos));
        }

        function agregarHabito() {
            const input = document.getElementById('nuevoHabito');
            if(input.value) {
                datos.habitos.push({nombre: input.value, check: false});
                input.value = '';
                render();
            }
        }

        function toggle(i) {
            datos.habitos[i].check = !datos.habitos[i].check;
            render();
            actualizarGrafico(); // Actualiza el gráfico en tiempo real hoy
        }

        // 2. Lógica del Gráfico
        let miChart;
        function actualizarGrafico() {
            const ctx = document.getElementById('graficoHabitos').getContext('2d');
            const etiquetas = Object.keys(datos.historial).slice(-30); // Últimos 30 registros
            const valores = Object.values(datos.historial).slice(-30);

            // Añadir el progreso de hoy al final del gráfico
            const hechosHoy = datos.habitos.filter(h => h.check).length;
            const totalHoy = datos.habitos.length;
            etiquetas.push("Hoy");
            valores.push(totalHoy > 0 ? (hechosHoy / totalHoy) * 100 : 0);

            if (miChart) miChart.destroy();
            miChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: etiquetas,
                    datasets: [{
                        label: '% de éxito',
                        data: valores,
                        borderColor: '#81c784',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(129, 199, 132, 0.1)'
                    }]
                },
                options: { scales: { y: { min: 0, max: 100 } } }
            });
        }

        verificarReinicio();
    </script>
</body>
</html>

